<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>斜阳</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://miaoxinwei.github.io/"/>
  <updated>2017-04-21T03:35:05.000Z</updated>
  <id>https://miaoxinwei.github.io/</id>
  
  <author>
    <name>LICO</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>spring 集成 websocket</title>
    <link href="https://miaoxinwei.github.io/2017/04/21/spring-%E9%9B%86%E6%88%90-websocket/"/>
    <id>https://miaoxinwei.github.io/2017/04/21/spring-集成-websocket/</id>
    <published>2017-04-21T03:26:18.000Z</published>
    <updated>2017-04-21T03:35:05.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>spring4.0以后加入了对websocket技术的支持，目前项目用的是SSM（springMVC+spring+MyBatis）框架，所以选择了spring自带的websocket。</p>
</blockquote>
<a id="more"></a>
<p>不多说，开始集成。</p>
<h4 id="在pom-xml文件中增加以下依赖"><a href="#在pom-xml文件中增加以下依赖" class="headerlink" title="在pom.xml文件中增加以下依赖"></a>在pom.xml文件中增加以下依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-messaging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.websocket<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.websocket-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="握手拦截器"><a href="#握手拦截器" class="headerlink" title="握手拦截器"></a>握手拦截器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketHandshakeInterceptor</span> <span class="keyword">extends</span> <span class="title">HttpSessionHandshakeInterceptor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">beforeHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response,</span></span></div><div class="line">                                   WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes) <span class="keyword">throws</span> Exception &#123;</div><div class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> ServletServerHttpRequest) &#123;</div><div class="line">            String openid = ((ServletServerHttpRequest) request).getServletRequest().getParameter(<span class="string">"openid"</span>);</div><div class="line"></div><div class="line">            attributes.put(<span class="string">"WEBSOCKET_USERNAME"</span>, openid);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.beforeHandshake(request, response, wsHandler, attributes);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response,</span></span></div><div class="line">                               WebSocketHandler wsHandler, Exception ex) &#123;</div><div class="line">        <span class="keyword">super</span>.afterHandshake(request, response, wsHandler, ex);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="业务拦截器"><a href="#业务拦截器" class="headerlink" title="业务拦截器"></a>业务拦截器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnionpaySocketHandler</span> <span class="keyword">extends</span> <span class="title">TextWebSocketHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(UnionpaySocketHandler.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ConcurrentMap&lt;String, WebSocketSession&gt; sessions;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        sessions = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//接收文本消息，并发送出去</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handleTextMessage</span><span class="params">(WebSocketSession session, TextMessage message)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        String msg = message.getPayload();</div><div class="line"></div><div class="line">        TextMessage returnMessage = <span class="keyword">new</span> TextMessage(msg);</div><div class="line">        session.sendMessage(returnMessage);</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.handleTextMessage(session, message);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//连接建立后处理</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String openid = (String) session.getAttributes().get(<span class="string">"WEBSOCKET_USERNAME"</span>);</div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(openid)) &#123;</div><div class="line">            logger.info(<span class="string">"用户 &gt;&gt; &#123;&#125; 建立连接"</span>, openid);</div><div class="line"></div><div class="line">            sessions.put(openid, session);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//抛出异常时处理</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleTransportError</span><span class="params">(WebSocketSession session, Throwable exception)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (session.isOpen()) &#123;</div><div class="line">            session.close();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String openid = (String) session.getAttributes().get(<span class="string">"WEBSOCKET_USERNAME"</span>);</div><div class="line"></div><div class="line">        sessions.remove(openid);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//连接关闭后处理</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus closeStatus)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        String openid = (String) session.getAttributes().get(<span class="string">"WEBSOCKET_USERNAME"</span>);</div><div class="line"></div><div class="line">        logger.info(<span class="string">"用户 &gt;&gt; &#123;&#125; 退出连接"</span>, openid);</div><div class="line"></div><div class="line">        sessions.remove(openid);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 给某个用户发送消息</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> userName</div><div class="line">     * <span class="doctag">@param</span> msg</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageToUser</span><span class="params">(String userName, String msg)</span> </span>&#123;</div><div class="line">        WebSocketSession session = sessions.get(userName);</div><div class="line">        <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                TextMessage message = <span class="keyword">new</span> TextMessage(msg);</div><div class="line"></div><div class="line">                session.sendMessage(message);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                logger.error(<span class="string">"发送信息异常, ex = &#123;&#125;"</span>, ExceptionUtils.getStackTrace(e));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableWebSocket</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfiguration</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> </span>&#123;</div><div class="line">        registry</div><div class="line">                .addHandler(unionpaySocketHandler(), <span class="string">"/unionpayServer"</span>)</div><div class="line">                .setAllowedOrigins(<span class="string">"*"</span>)<span class="comment">//允许所有域访问</span></div><div class="line">                .addInterceptors(myInterceptor());</div><div class="line">        registry</div><div class="line">                .addHandler(unionpaySocketHandler(), <span class="string">"/unionpayServer/sockjs"</span>)</div><div class="line">                .setAllowedOrigins(<span class="string">"*"</span>)</div><div class="line">                .addInterceptors(myInterceptor())</div><div class="line">                .withSockJS();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> UnionpaySocketHandler <span class="title">unionpaySocketHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UnionpaySocketHandler();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> WebSocketHandshakeInterceptor <span class="title">myInterceptor</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebSocketHandshakeInterceptor();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="web-xml增加配置"><a href="#web-xml增加配置" class="headerlink" title="web.xml增加配置"></a>web.xml增加配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springDispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath*:spring/spring-mvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></div><div class="line">  **<span class="tag">&lt;<span class="name">async-supported</span>&gt;</span>true<span class="tag">&lt;/<span class="name">async-supported</span>&gt;</span>//需要增加此项  允许异步(未测试是否必须配置)</div><div class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="以下重点"><a href="#以下重点" class="headerlink" title="以下重点"></a>以下重点</h3><p>如果使用了nginx做代理，则nginx需要增加配置，否则websocket开启会报错301或者400或者500等</p>
<ul>
<li>以下为例子</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">location /websocket &#123;</div><div class="line">		proxy_pass   http://127.0.0.1:9090/unionpayServer;</div><div class="line">		proxy_http_version 1.1;</div><div class="line">		proxy_set_header Upgrade $http_upgrade;</div><div class="line">		proxy_set_header Connection "upgrade";</div><div class="line">		proxy_read_timeout 300s;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="前端调用方法示例"><a href="#前端调用方法示例" class="headerlink" title="前端调用方法示例"></a>前端调用方法示例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">websocket = <span class="keyword">new</span> WebSocket(<span class="string">"wss://localhost:8080/websocket?openid=123"</span>);<span class="comment">//如果为http,wss改为ws</span></div></pre></td></tr></table></figure>
<h4 id="至此，整个websocket配置已完成。"><a href="#至此，整个websocket配置已完成。" class="headerlink" title="至此，整个websocket配置已完成。"></a>至此，整个websocket配置已完成。</h4>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;spring4.0以后加入了对websocket技术的支持，目前项目用的是SSM（springMVC+spring+MyBatis）框架，所以选择了spring自带的websocket。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="JAVA" scheme="https://miaoxinwei.github.io/categories/JAVA/"/>
    
    
      <category term="Spring" scheme="https://miaoxinwei.github.io/tags/Spring/"/>
    
      <category term="websocket" scheme="https://miaoxinwei.github.io/tags/websocket/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://miaoxinwei.github.io/2017/04/20/hello%20world/"/>
    <id>https://miaoxinwei.github.io/2017/04/20/hello world/</id>
    <published>2017-04-20T07:13:16.000Z</published>
    <updated>2017-04-21T06:15:03.000Z</updated>
    
    <content type="html"><![CDATA[<p>Hello, this world！</p>
<a id="more"></a>
<p>没有啦~~~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Hello, this world！&lt;/p&gt;
    
    </summary>
    
      <category term="生活" scheme="https://miaoxinwei.github.io/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
      <category term="闲谈" scheme="https://miaoxinwei.github.io/tags/%E9%97%B2%E8%B0%88/"/>
    
  </entry>
  
</feed>
